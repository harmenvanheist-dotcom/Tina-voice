<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tina – Voice Assistant</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{
      --bg:#5a2b78;
      --panel:#3f2458cc;
      --panel-strong:#3b2254;
      --txt:#f2eff7;
      --muted:#c9bfe0;
      --acid:#cfff37;   /* accent geelgroen */
      --shadow:0 12px 40px rgba(0,0,0,.25);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1000px 600px at 20% -10%, #7a4ba3 0%, transparent 60%),
        radial-gradient(1000px 600px at 90% 20%, #6a2b8a 0%, transparent 60%),
        linear-gradient(180deg, #421a62 0%, #2e1346 100%);
      min-height:100%;
    }
    a{color:var(--muted);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{
      max-width:1100px;
      margin:40px auto;
      padding:0 16px;
    }
    .card{
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    header.card{
      display:flex;align-items:center;gap:14px;
      padding:18px 20px;
    }
    header .logo{
      width:28px;height:28px;border-radius:6px;overflow:hidden;flex:0 0 28px
    }
    header .title{
      font-weight:800;font-size:28px;letter-spacing:.2px;color:var(--acid);
    }
    header .tagline{flex:1;color:var(--muted);font-size:14px}
    .status{
      background:#51406b;border:1px solid #6f5c8b;color:#e5e1f0;
      padding:6px 12px;border-radius:999px;font-size:12px;white-space:nowrap
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      margin-top:16px;
    }

    .left.card, .right.card{padding:22px}
    .mic-panel{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      border-radius:calc(var(--radius) - 6px);
      padding:22px;min-height:380px;background:var(--panel-strong);
    }
    .mic-circle{
      width:220px;height:220px;border-radius:50%;
      background:radial-gradient(circle at 35% 30%, #eaff7d 0%, #cfff37 60%, #b8ff18 100%);
      box-shadow:0 20px 40px rgba(0,0,0,.35), inset 0 12px 36px rgba(0,0,0,.15);
      display:grid;place-items:center;cursor:pointer;user-select:none;
      transition: transform .15s ease
    }
    .mic-circle:active{transform:scale(.98)}
    .mic{font-size:60px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
    .hint{margin-top:20px;color:var(--muted);text-align:center}

    .right .box{
      background:var(--panel-strong);
      border-radius:calc(var(--radius) - 6px);
      padding:18px 16px;
      margin-bottom:16px;
      min-height:160px;
    }
    .h{
      color:var(--acid);
      font-weight:900;
      letter-spacing:.5px;
      font-size:14px;
      margin:0 0 10px;
    }
    .out{white-space:pre-wrap}

    .controls{
      display:flex;gap:14px;align-items:center;justify-content:flex-start;margin-top:6px
    }
    .toggle{
      display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px
    }
    .pill{
      background:var(--acid);
      color:#2a1d44;
      border:none;border-radius:999px;
      padding:10px 14px;
      font-weight:700;cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
    }

    .promo.card{
      margin-top:18px;padding:18px;
    }
    .promo p{
      margin:0 0 12px 0;
      color:var(--txt);
      font-size:14px;
    }
    .promo b{color:var(--acid);font-weight:900}

    footer{
      color:var(--muted);
      font-size:12px;
      margin:14px 0 28px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center
    }

    /* mobile */
    @media (max-width: 860px){
      header .title{font-size:24px}
      .grid{grid-template-columns: 1fr}
      .mic-panel{min-height:320px}
      .mic-circle{width:180px;height:180px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="card">
      <a class="logo" href="https://morgenacademy.nl" target="_blank" rel="noopener">
        <img src="logo.png" alt="Morgen Academy" width="28" height="28" />
      </a>
      <div class="title">Tina</div>
      <div class="tagline">Jouw personal assistent — bespreek waar je mee bezig bent. Tina vat samen en geeft je belangrijkste to-do’s.</div>
      <div id="status" class="status">Status: klaar</div>
    </header>

    <!-- Main -->
    <div class="grid">
      <!-- Left: microphone -->
      <section class="left card">
        <div class="mic-panel">
          <div id="mic" class="mic-circle" title="Klik om te spreken">
            <div class="mic">🎤</div>
          </div>
          <div class="hint">Klik om te spreken. Nogmaals klikken = stoppen.</div>
        </div>
      </section>

      <!-- Right: transcript + answer -->
      <section class="right card">
        <div class="box">
          <p class="h">TRANSCRIPT</p>
          <div id="transcript" class="out">Hier verschijnt wat je zegt...</div>
        </div>

        <div class="box" style="min-height:200px">
          <p class="h">SAMENVATTING EN TO-DO’S</p>
          <div id="answer" class="out">—</div>
          <div class="controls">
            <label class="toggle">
              <input id="ttsToggle" type="checkbox" />
              <span>Antwoorden voorlezen</span>
            </label>
            <button id="clearBtn" class="pill" type="button">Wis gesprek</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Promo (kleiner & subtieler) -->
    <section class="promo card">
      <p><b>Slimmer werken met AI</b> zodat jij tijd hebt voor leuke dingen. Of je nu elke dag in meetings zit, eindeloze to-do’s hebt of je business runt in de avonden: met Morgen Academy maak je je werkdag leuker en slimmer — ook als je geen tech-expert bent.</p>
      <a class="pill" href="https://morgenacademy.nl" target="_blank" rel="noopener">Ontdek trainingen</a>
    </section>

    <!-- Footer -->
    <footer>
      <span>Werkt alleen via <strong>HTTPS</strong> en na een gebruikersactie. iOS Safari: tabblad actief houden.</span>
      <span>•</span>
      <span>Tina slaat geen data op; niets van wat je bespreekt of ontvangt is zichtbaar voor Morgen Academy.</span>
      <span>•</span>
      <span>Prototype · <a href="https://morgenacademy.nl" target="_blank" rel="noopener">Morgen Academy</a></span>
    </footer>
  </div>

  <script>
    // ------- UI helpers -------
    const qs = s => document.querySelector(s);
    const statusEl = qs('#status');
    const micEl = qs('#mic');
    const transcriptEl = qs('#transcript');
    const answerEl = qs('#answer');
    const ttsToggle = qs('#ttsToggle');
    const clearBtn = qs('#clearBtn');

    function setStatus(txt){ statusEl.textContent = 'Status: ' + txt; }
    function speak(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'nl-NL';
        u.rate = 1.02;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){}
    }

    // ------- Conversation memory (lichtgewicht) -------
    const MAX_TURNS = 6; // laatste 6 uitwisselingen
    let history = [];    // {role:'user'|'assistant', content:''}

    function pushHistory(role, content){
      history.push({ role, content });
      if(history.length > MAX_TURNS*2){
        history = history.slice(-MAX_TURNS*2);
      }
    }

    // ------- Speech-to-text (webkitSpeechRecognition / fallback) -------
    let recognizing = false;
    let recog;

    function startSTT(){
      if('webkitSpeechRecognition' in window){
        recog = new webkitSpeechRecognition();
        recog.lang = 'nl-NL';
        recog.interimResults = true;
        recog.continuous = true;
        let finalText = '';

        recog.onstart = () => { recognizing = true; setStatus('luisteren…'); };
        recog.onresult = (e) => {
          let interim = '';
          for(let i=e.resultIndex;i<e.results.length;i++){
            const res = e.results[i];
            if(res.isFinal) finalText += res[0].transcript;
            else interim += res[0].transcript;
          }
          transcriptEl.textContent = (finalText + interim).trim();
        };
        recog.onerror = () => { setStatus('fout'); };
        recog.onend = async () => {
          recognizing = false;
          const text = transcriptEl.textContent.trim();
          if(text){
            await askTina(text);
          }else{
            setStatus('klaar');
          }
        };
        recog.start();
      }else{
        // geen STT beschikbaar
        const text = prompt('Geen microfoon-API beschikbaar. Typ hier je bericht:');
        if(text){
          transcriptEl.textContent = text;
          askTina(text);
        }
      }
    }

    function stopSTT(){
      try{ if(recog) recog.stop(); }catch(e){}
    }

    micEl.addEventListener('click', () => {
      if(recognizing){ stopSTT(); }
      else { startSTT(); }
    });

    clearBtn.addEventListener('click', () => {
      history = [];
      transcriptEl.textContent = 'Hier verschijnt wat je zegt...';
      answerEl.textContent = '—';
      setStatus('klaar');
      speechSynthesis.cancel();
    });

    // ------- Call Netlify Function -------
    async function askTina(input){
      try{
        setStatus('verwerken…');
        pushHistory('user', input);

        // stuur beknopte conversatie mee
        const payload = {
          input,
          history // de function houdt al rekening met max tokens + systeemprompt
        };

        const resp = await fetch('/.netlify/functions/ask-tina', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if(!resp.ok){
          const t = await resp.text();
          answerEl.textContent = 'Fout bij ophalen antwoord.';
          console.error('Function error:', t);
          setStatus('fout');
          return;
        }

        const data = await resp.json();
        const reply = (data.reply || '').trim() || '(geen antwoord)';
        answerEl.textContent = reply;
        pushHistory('assistant', reply);

        // optioneel voorlezen
        if(ttsToggle.checked) speak(reply);

        // eenvoudige “doorpraat” heuristiek: als laatste zin eindigt met vraagteken,
        // laat status “wachten op antwoord” zien.
        const lastChar = reply.slice(-1);
        setStatus(lastChar === '?' ? 'wachten op antwoord…' : 'klaar');
      }catch(err){
        console.error(err);
        answerEl.textContent = 'Er ging iets mis.';
        setStatus('fout');
      }
    }
  </script>
</body>
</html>
